<!DOCTYPE html><html lang="en" itemscope itemtype="http://schema.org/WebPage"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Refactoring CanCan(Can) Abilities | Brewing Bits</title><meta name=description content=""><meta name=viewport content="width=device-width, initial-scale=1"><meta http-equiv="cache-control" content="public"/><meta http-equiv="pragma" content="public"><meta name="keywords" content="Typing, Theme, Jekyll" /><meta name="author" content="Paul" /><meta property="og:locale" content="en" /><meta property="og:site_name" content="Brewing Bits" /><meta property="og:type" content="WebSite" /><meta property="og:url" content="https://haniyya.github.io/blog/refactoring-cancan/" /><meta property="og:description" content="Brewing delicious code for you." /><meta property="og:title" content="Refactoring CanCan(Can) Abilities - Brewing Bits" /><link rel="canonical" href="https://haniyya.github.io/blog/refactoring-cancan/"><link rel="alternate" type="application/rss+xml" title="Brewing Bits" href="https://haniyya.github.io/feed.xml"> <script type="application/ld+json"> {"@context": "http://schema.org", "@type": "WebSite", "name": "Paul", "headline": "Brewing Bits", "author": {"@type": "Person", "name": {"Brewing Bits"}}, "description": "Brewing delicious code for you.", "url": "https://haniyya.github.io"} </script> <script type="text/javascript"> var GLOBAL_BASEURL = "https://haniyya.github.io"; </script><link rel="icon" type="image/png" sizes="32x32" href="https://haniyya.github.io/assets/images/favicon/favicon-32x32.png"><link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"><link href="https://fonts.googleapis.com/css?family=Space+Mono" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,600i,700,700i,800,800i" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet"><link rel="stylesheet" href="https://haniyya.github.io/assets/stylesheets/main.css"> <script> var url_site = "https://haniyya.github.io", url_production = "http://localhost:4000"; if (url_site != url_production) { (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-106066883-1', 'auto'); ga('set', 'forceSSL', true); ga('send', 'pageview'); }; </script></head><body><div class="main" id="top"><div class="container wrapper"><div class="row"><div class="col-sm-3 sidebar"><div class="row avatar"> <a href="https://haniyya.github.io/"> <img class="img-responsive center-block avatar-img" src="https://haniyya.github.io/assets/images/avatar/logo_export.svg" height="165" width="165" alt="Brewing Bits"> </a></div><div class="row header"><h2><a href="https://haniyya.github.io">Grab a seat, <br> have a cup. </a></h2></div><div class="row menu"><ul><li class="nav-item"> <i class="fa fa-home" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/">Hello</a></li><hr class="breakline"><li class="nav-item"> <i class="fa fa-edit" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/blog/" >Blog</a></li><li class="nav-item"> <i class="fa fa-search" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/blog/search/" >Search</a></li><li class="nav-item"> <i class="fa fa-tags" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/blog/tags/" >Tags</a></li><li class="nav-item"> <i class="fa fa-briefcase" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/projects/" onclick="ga('send', 'event', 'linkTo', 'https://haniyya.github.io/projects/', 'Projects');" >Projects</a></li><li class="nav-item"> <i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/resume/" onclick="ga('send', 'event', 'linkTo', 'https://haniyya.github.io/resume/', 'Resume');" >Resume</a></li><li class="nav-item"> <i class="fa fa-rss" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/feed.xml" >Feed</a></li><li class="nav-item"> <i class="fa fa-envelope" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/contact/" >Contact</a></li></ul><div class="socials"><div class="row"><p></p><p>Follow Me!</p><div id="github" class="col-sm-4 columns"> <a href="https://github.com/Haniyya" target="_blank" title="GitHub" onclick="ga('send', 'event', 'linkTo', 'GitHub', 'Social Network', {useBeacon: true});" > <i class="fa fa-github icon" aria-hidden="true"></i> </a></div><div id="twitter" class="col-sm-4 columns"> <a href="https://twitter.com/BrewingBits/" target="_blank" title="Twitter" onclick="ga('send', 'event', 'linkTo', 'Twitter', 'Social Network', {useBeacon: true});" > <i class="fa fa-twitter icon" aria-hidden="true"></i> </a></div><div id="email" class="col-sm-4 columns"> <a href="https://tinyletter.com/BrewingBits" target="_blank" title="Email" onclick="ga('send', 'event', 'linkTo', 'Email', 'Social Network', {useBeacon: true});" > <i class="fa fa-envelope icon" aria-hidden="true"></i> </a></div></div></div></div><form class="tinyletter" style="border:1px solid #ccc;padding:3px;text-align:center;" action="https://tinyletter.com/BrewingBits" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/BrewingBits', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><p><label for="tlemail">I won't pester you much! Promise!</label></p><p><input type="text" style="width:140px" name="email" id="tlemail" /></p><input type="hidden" value="1" name="embed"/><input type="submit" value="Subscribe" /><p><a href="https://tinyletter.com" target="_blank">powered by TinyLetter</a></p></form></div><div class="col-sm-9 content-main"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="row title"><h1>Refactoring CanCan(Can) Abilities</h1></div><div class="row meta" datetime="2017-09-07"> <time class="col-sm-6 datetime"> <i class="fa fa-calendar" aria-hidden="true"></i><span class="text tmargin "> September 07, 2017 </span> </time><div class="col-sm-6 count-comments"> <span class="wrap"><i class="fa fa-comments" aria-hidden="true"></i>&nbsp;<a href="#comments" data-disqus-identifier="/blog/refactoring-cancan/">0</a></span></div></div><div class="row tag-list"> <i class="fa fa-tags" aria-hidden="true"></i> <a href="https://haniyya.github.io/blog/tags//ruby">ruby</a> <a href="https://haniyya.github.io/blog/tags//rails">rails</a> <a href="https://haniyya.github.io/blog/tags//cancan">cancan</a> <a href="https://haniyya.github.io/blog/tags//programming">programming</a></div><div class="row"> Read this in "about 5 minutes".</div><div class="row content"><ul id="markdown-toc"><li><a href="#use-arrays" id="markdown-toc-use-arrays">Use Arrays</a><ul><li><a href="#bad" id="markdown-toc-bad">Bad:</a></li><li><a href="#good" id="markdown-toc-good">Good:</a></li></ul></li><li><a href="#prefer-hashes-to-blocks" id="markdown-toc-prefer-hashes-to-blocks">Prefer hashes to blocks</a><ul><li><a href="#bad-1" id="markdown-toc-bad-1">Bad:</a></li><li><a href="#good-1" id="markdown-toc-good-1">Good:</a></li></ul></li><li><a href="#if-you-use-concerns-use-concerns" id="markdown-toc-if-you-use-concerns-use-concerns">If you use concerns, use concerns</a><ul><li><a href="#bad-2" id="markdown-toc-bad-2">Bad:</a></li><li><a href="#good-2" id="markdown-toc-good-2">Good:</a></li></ul></li><li><a href="#use-cannot-for-exceptions-instead-of-blocks" id="markdown-toc-use-cannot-for-exceptions-instead-of-blocks">Use <code>cannot</code> for exceptions instead of blocks</a><ul><li><a href="#bad-3" id="markdown-toc-bad-3">Bad:</a></li><li><a href="#good-3" id="markdown-toc-good-3">Good:</a></li></ul></li><li><a href="#use-merge-to-extract-logic-from-your-main-ability" id="markdown-toc-use-merge-to-extract-logic-from-your-main-ability">Use <code>#merge</code> to extract logic from your main ability</a><ul><li><a href="#bad-4" id="markdown-toc-bad-4">Bad:</a></li><li><a href="#good-4" id="markdown-toc-good-4">Good:</a></li></ul></li><li><a href="#further-reading" id="markdown-toc-further-reading">Further Reading</a></li></ul><p>If you have a somewhat complicated set of authorization-rules in your system, your <a href="https://github.com/CanCanCommunity/cancancan/">CanCan(Can)</a> Abilities can become quite unwieldy. Here are some tips to make them more manageable.</p><h2 id="use-arrays">Use Arrays</h2><p>There is an antipattern when using <code>CanCan::Ability</code>, that iterates over objects or verbs to define a bunch of rules that could be expressed a lot easier. Example:</p><h3 id="bad">Bad:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>

<span class="o">[</span><span class="ss">:message</span><span class="p">,</span> <span class="ss">:block</span><span class="p">,</span> <span class="ss">:like</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">verb</span><span class="o">|</span>
  <span class="n">can</span> <span class="n">verb</span><span class="p">,</span> <span class="no">UserProfile</span>
<span class="k">end</span></code></pre></figure><p>This defining 3 rules, where only one is needed.</p><h3 id="good">Good:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>

<span class="n">can</span> <span class="o">[</span><span class="ss">:message</span><span class="p">,</span> <span class="ss">:block</span><span class="p">,</span> <span class="ss">:like</span><span class="o">]</span><span class="p">,</span> <span class="no">UserProfile</span>

<span class="c1"># Or use a literal</span>

<span class="n">can</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="n">message</span> <span class="n">block</span> <span class="n">like</span><span class="p">),</span> <span class="no">UserProfile</span>

<span class="c1"># You can use this on the objects as well</span>
<span class="n">can</span> <span class="ss">:ignore</span><span class="p">,</span> <span class="o">[</span><span class="no">UserProfile</span><span class="p">,</span> <span class="no">Admin</span><span class="o">]</span></code></pre></figure><h2 id="prefer-hashes-to-blocks">Prefer hashes to blocks</h2><p>Block arguments to rules are slow and cannot be used in db-queries. If you can (and you won’t always be able to) you should instead use hash-arguments:</p><h3 id="bad-1">Bad:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>

<span class="c1"># Assuming you refer to your logged in user with `user`</span>
<span class="n">can</span> <span class="ss">:edit</span><span class="p">,</span> <span class="no">Post</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
  <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">user</span>
<span class="k">end</span></code></pre></figure><h3 id="good-1">Good:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>

<span class="n">can</span> <span class="ss">:edit</span><span class="p">,</span> <span class="no">Post</span><span class="p">,</span> <span class="ss">author</span><span class="p">:</span> <span class="n">user</span></code></pre></figure><h2 id="if-you-use-concerns-use-concerns">If you use concerns, use concerns</h2><p>If you use <a href="http://api.rubyonrails.org/classes/ActiveSupport/Concern.html">Concerns</a> you can use that fact to skip tests in your rules. Since <code>CanCan</code> internally uses <a href="https://ruby-doc.org/core-2.4.1/Object.html#method-i-kind_of-3F"><code>#kind_of?</code></a> to test for applicable rules, you can just as well pass modules as objects of your rules.</p><h3 id="bad-2">Bad:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>

<span class="n">can</span> <span class="ss">:message</span><span class="p">,</span> <span class="o">[</span><span class="no">User</span><span class="p">,</span> <span class="no">Admin</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:received_messages</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure><h3 id="good-2">Good:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>
<span class="c1"># Assuming both User and Admin include a messageable concern to send them</span>
<span class="c1"># messages.</span>

<span class="n">can</span> <span class="ss">:message</span><span class="p">,</span> <span class="no">Messageable</span></code></pre></figure><h2 id="use-cannot-for-exceptions-instead-of-blocks">Use <code>cannot</code> for exceptions instead of blocks</h2><p>If you have exceptions to a rule, or negative conditions, try to use <code>cannot</code>!</p><h3 id="bad-3">Bad:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">can</span> <span class="ss">:message</span><span class="p">,</span> <span class="no">User</span>

<span class="c1"># You can block everyone but yourself</span>
<span class="n">can</span> <span class="ss">:block</span><span class="p">,</span> <span class="no">User</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span> <span class="o">!=</span> <span class="n">current_user</span>
<span class="k">end</span></code></pre></figure><p>Again, this is slow and not SQL compatible. Instead use something like this:</p><h3 id="good-3">Good:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">can</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="n">message</span> <span class="n">block</span><span class="p">),</span> <span class="no">User</span>
<span class="n">cannot</span> <span class="ss">:block</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span></code></pre></figure><p>Remember the rule-precedence of CanCan: Rules you define later will override the earlier ones.</p><h2 id="use-merge-to-extract-logic-from-your-main-ability">Use <code>#merge</code> to extract logic from your main ability</h2><p>If you tried all of the above but somehow still have a file that is way to long, you can try to split it into multiple small abilities (you could call them faculties).</p><h3 id="bad-4">Bad:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># ability.rb</span>

<span class="k">class</span> <span class="nc">Ability</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="n">can</span> <span class="ss">:message</span><span class="p">,</span> <span class="no">User</span>
    <span class="n">can</span> <span class="ss">:block</span><span class="p">,</span> <span class="no">User</span>
    <span class="n">can</span> <span class="ss">:edit</span><span class="p">,</span> <span class="no">Post</span><span class="p">,</span> <span class="ss">author</span><span class="p">:</span> <span class="n">current_user</span>

    <span class="c1"># 300 lines later</span>

    <span class="n">cannot</span> <span class="ss">:block</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><h3 id="good-4">Good:</h3><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Ability</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="o">[</span><span class="no">ContentFaculty</span><span class="p">,</span> <span class="no">InteractionFaculty</span><span class="o">].</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
      <span class="n">merge</span> <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
     <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ContentFaculty</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="n">can</span> <span class="ss">:edit</span><span class="p">,</span> <span class="no">Post</span><span class="p">,</span> <span class="ss">author</span><span class="p">:</span> <span class="n">current_user</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">InteractionFaculty</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="n">can</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="n">message</span> <span class="n">block</span><span class="p">),</span> <span class="no">User</span>
    <span class="n">cannot</span> <span class="ss">:block</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><p>This way you can keep the scope and responsibility of your ability small, and your faculties easily testable.</p><h2 id="further-reading">Further Reading</h2><p>You can always have a look at the official <a href="https://github.com/CanCanCommunity/cancancan/wiki/Defining-Abilities:-Best-Practice">best practices</a> or if you are feeling adventurous you can <code>gem open cancancan</code> and have a look into the source code yourself!</p><hr style="border-top: 1px solid #9D9D9D ; color: #9D9D9D ;" class="endpost" /><div class="row sharebutton"><ul class="wrapper"><li class="title">Share</li></ul></div><div class="day-quote"><div class="title"></div><div class="content"></div></div><div class="row author"><div class="col-sm-2 image"> <img class="img-responsive center-block" src="https://haniyya.github.io/assets/images/author/logo_export.svg" alt=""></div><div class="col-sm-10 bio"><p class="title">Author</p><p class="name">Paul</p><p class="content">Independent Webdeveloper based in Kiel, Germany. Come read my stuff!</p></div></div><div class="disqus" id="comments"><div class="title"><h3><i class="fa fa-comments" aria-hidden="true"></i>&nbsp;Leave a comment on this post</h3></div><div class="content"><div id="disqus_thread"></div><script> var disqus_shortname = "brewing-bits-com"; var disqus_config = function () { if(typeof(this.page) == "undefined"){ this.page = {}; }; this.page.url = "https://brewing-bits.com/blog/refactoring-cancan/"; this.page.identifier = "/blog/refactoring-cancan/"; this.page.title = "Refactoring CanCan(Can) Abilities"; }; (function() { var d = document, s = d.createElement("script"); s.src = "https://brewing-bits-com.disqus.com/embed.js"; s.setAttribute("data-timestamp", +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></article></div></div></div><div class="footer"><div class="container-fluid"><div class="row-fluid"><div class="col-sm-4 copyright"> <span>Brewing Bits © 2016-2020 • All right reserved.</span></div><div class="col-sm-4 message"> <span>Brewing delicious lines of code.</span></div><div class="col-sm-4 madeby"> <span>Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div><a class="pull-right top" href="#top"><i class="fa fa-caret-up" aria-hidden="true"></i></a></div></div></div></div><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> <script src="https://haniyya.github.io/assets/javascripts/jekyll-spotify-plugin.min.js"></script> <script type="text/javascript" src="https://haniyya.github.io/assets/javascripts/post.js"></script> <script type="text/javascript"> jQuery(document).ready(function($) { $('.post > .row.content a').addClass('ga-event'); $('.page.spage > .row.content th a').addClass('ga-event'); $('.row.content li a').removeClass('ga-event'); $('a.ga-event').attr('onclick', 'ga(\'send\',\'event\',\'linkTo\',this.href,\'https://haniyya.github.io/blog/refactoring-cancan/\');'); }); </script> <script src="https://haniyya.github.io/assets/javascripts/global.js"></script></body></html>
