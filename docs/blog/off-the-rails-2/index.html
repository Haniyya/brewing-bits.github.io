<!DOCTYPE html><html lang="en" itemscope itemtype="http://schema.org/WebPage"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Off the Rails! Part 2. | Brewing Bits</title><meta name=description content="Hail hydra! This is Part 2 in a multiple part series where we try to emancipateourselves from Ruby on Rails by going back to basics! If you missed Part 1 whe..."><meta name=viewport content="width=device-width, initial-scale=1"><meta http-equiv="cache-control" content="public"/><meta http-equiv="pragma" content="public"><meta name="keywords" content="Typing, Theme, Jekyll" /><meta name="author" content="Paul" /><meta property="og:locale" content="en" /><meta property="og:site_name" content="Brewing Bits" /><meta property="og:type" content="WebSite" /><meta property="og:url" content="https://haniyya.github.io/blog/off-the-rails-2/" /><meta property="og:description" content="Brewing delicious code for you." /><meta property="og:title" content="Off the Rails! Part 2. - Brewing Bits" /><link rel="canonical" href="https://haniyya.github.io/blog/off-the-rails-2/"><link rel="alternate" type="application/rss+xml" title="Brewing Bits" href="https://haniyya.github.io/feed.xml"> <script type="application/ld+json"> {"@context": "http://schema.org", "@type": "WebSite", "name": "Paul", "headline": "Brewing Bits", "author": {"@type": "Person", "name": {"Brewing Bits"}}, "description": "Brewing delicious code for you.", "url": "https://haniyya.github.io"} </script> <script type="text/javascript"> var GLOBAL_BASEURL = "https://haniyya.github.io"; </script><link rel="icon" type="image/png" sizes="32x32" href="https://haniyya.github.io/assets/images/favicon/favicon-32x32.png"><link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"><link href="https://fonts.googleapis.com/css?family=Space+Mono" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,600i,700,700i,800,800i" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet"><link rel="stylesheet" href="https://haniyya.github.io/assets/stylesheets/main.css"> <script> var url_site = "https://haniyya.github.io", url_production = "http://localhost:4000"; if (url_site != url_production) { (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-106066883-1', 'auto'); ga('set', 'forceSSL', true); ga('send', 'pageview'); }; </script></head><body><div class="main" id="top"><div class="container wrapper"><div class="row"><div class="col-sm-3 sidebar"><div class="row avatar"> <a href="https://haniyya.github.io/"> <img class="img-responsive center-block avatar-img" src="https://haniyya.github.io/assets/images/avatar/logo_export.svg" height="165" width="165" alt="Brewing Bits"> </a></div><div class="row header"><h2><a href="https://haniyya.github.io">Grab a seat, <br> have a cup. </a></h2></div><div class="row menu"><ul><li class="nav-item"> <i class="fa fa-home" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/">Hello</a></li><hr class="breakline"><li class="nav-item"> <i class="fa fa-edit" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/blog/" >Blog</a></li><li class="nav-item"> <i class="fa fa-search" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/blog/search/" >Search</a></li><li class="nav-item"> <i class="fa fa-tags" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/blog/tags/" >Tags</a></li><li class="nav-item"> <i class="fa fa-briefcase" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/projects/" onclick="ga('send', 'event', 'linkTo', 'https://haniyya.github.io/projects/', 'Projects');" >Projects</a></li><li class="nav-item"> <i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/resume/" onclick="ga('send', 'event', 'linkTo', 'https://haniyya.github.io/resume/', 'Resume');" >Resume</a></li><li class="nav-item"> <i class="fa fa-rss" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/feed.xml" >Feed</a></li><li class="nav-item"> <i class="fa fa-envelope" aria-hidden="true"></i>&nbsp;<a href="https://haniyya.github.io/contact/" >Contact</a></li></ul><div class="socials"><div class="row"><p></p><p>Follow Me!</p><div id="github" class="col-sm-4 columns"> <a href="https://github.com/Haniyya" target="_blank" title="GitHub" onclick="ga('send', 'event', 'linkTo', 'GitHub', 'Social Network', {useBeacon: true});" > <i class="fa fa-github icon" aria-hidden="true"></i> </a></div><div id="twitter" class="col-sm-4 columns"> <a href="https://twitter.com/BrewingBits/" target="_blank" title="Twitter" onclick="ga('send', 'event', 'linkTo', 'Twitter', 'Social Network', {useBeacon: true});" > <i class="fa fa-twitter icon" aria-hidden="true"></i> </a></div><div id="email" class="col-sm-4 columns"> <a href="https://tinyletter.com/BrewingBits" target="_blank" title="Email" onclick="ga('send', 'event', 'linkTo', 'Email', 'Social Network', {useBeacon: true});" > <i class="fa fa-envelope icon" aria-hidden="true"></i> </a></div></div></div></div><form class="tinyletter" style="border:1px solid #ccc;padding:3px;text-align:center;" action="https://tinyletter.com/BrewingBits" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/BrewingBits', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><p><label for="tlemail">I won't pester you much! Promise!</label></p><p><input type="text" style="width:140px" name="email" id="tlemail" /></p><input type="hidden" value="1" name="embed"/><input type="submit" value="Subscribe" /><p><a href="https://tinyletter.com" target="_blank">powered by TinyLetter</a></p></form></div><div class="col-sm-9 content-main"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="row title"><h1>Off the Rails! Part 2.</h1></div><div class="row meta" datetime="2017-09-15"> <time class="col-sm-6 datetime"> <i class="fa fa-calendar" aria-hidden="true"></i><span class="text tmargin "> September 15, 2017 </span> </time><div class="col-sm-6 count-comments"> <span class="wrap"><i class="fa fa-comments" aria-hidden="true"></i>&nbsp;<a href="#comments" data-disqus-identifier="/blog/off-the-rails-2/">0</a></span></div></div><div class="row tag-list"> <i class="fa fa-tags" aria-hidden="true"></i> <a href="https://haniyya.github.io/blog/tags//ruby">ruby</a> <a href="https://haniyya.github.io/blog/tags//rails">rails</a> <a href="https://haniyya.github.io/blog/tags//grape">grape</a> <a href="https://haniyya.github.io/blog/tags//programming">programming</a> <a href="https://haniyya.github.io/blog/tags//sequel">sequel</a> <a href="https://haniyya.github.io/blog/tags//postgres">postgres</a> <a href="https://haniyya.github.io/blog/tags//sqlite">sqlite</a></div><div class="row"> Read this in "about 14 minutes".</div><div class="row content"><p>Hail hydra! This is Part 2 in a multiple part series where we try to emancipate ourselves from Ruby on Rails by going back to basics! If you missed Part 1 where we implemented our API, you can just click <a href="/blog/off-the-rails/">here</a>.</p><p>As always (in this series at least) you can come along for the ride by having a look at the <a href="https://github.com/BrewingBits/off-the-rails">git repository</a>. Just clone the repo and checkout the <code>part2</code> tag.</p><ul id="markdown-toc"><li><a href="#intro" id="markdown-toc-intro">Intro</a></li><li><a href="#adding-bundler" id="markdown-toc-adding-bundler">Adding Bundler</a></li><li><a href="#simplest-sequel" id="markdown-toc-simplest-sequel">Simplest Sequel</a></li><li><a href="#getting-an-interface-to-the-database" id="markdown-toc-getting-an-interface-to-the-database">Getting an interface to the database</a></li><li><a href="#connecting-all-the-bits" id="markdown-toc-connecting-all-the-bits">Connecting all the bits</a></li><li><a href="#adding-postgres" id="markdown-toc-adding-postgres">Adding Postgres</a></li><li><a href="#managing-the-database" id="markdown-toc-managing-the-database">Managing the database</a><ul><li><a href="#the-basic-tasks" id="markdown-toc-the-basic-tasks">The basic tasks</a></li><li><a href="#using-dotenv" id="markdown-toc-using-dotenv">Using dotenv</a></li><li><a href="#switching-to-pg" id="markdown-toc-switching-to-pg">Switching to pg</a></li></ul></li><li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li><li><a href="#next-time" id="markdown-toc-next-time">Next time</a></li></ul><h2 id="intro">Intro</h2><p>So <a href="/blog/off-the-rails/">last time</a> we built ourselves a little Grape based API that can save and return books (as long as you don’t restart the server). This time around we’ll get a little more sophisticated by bringing some structure to our application, adding <a href="https://bundler.io">Bundler</a>, <a href="https://github.com/ruby/rake">Rake</a> and, most importantly, a way to persist our books using [Sequel][sequel] and a postgres database.</p><h2 id="adding-bundler">Adding Bundler</h2><p>Since we are going to have more than two dependencies (<code>rack</code> and <code>grape</code>), we can use the chance to use <code>bundler</code>. Our ruby-dependency-manager of choice. So our project is only a two steps away from its own dependency-manager:</p><ol><li>Install bundler itself <code>gem install bundler</code></li><li><code>cd</code> into your projects directory and run <code>bundle init</code></li></ol><p>You should now see a new file in your directory called <code>Gemfile</code>. Here we can first put the gems used last time around:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># frozen_string_literal: true</span>

<span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">git_source</span><span class="p">(</span><span class="ss">:github</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">repo_name</span><span class="o">|</span> <span class="s2">&quot;https://github.com/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>

<span class="n">gem</span> <span class="s1">&#39;grape&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;rack&#39;</span></code></pre></figure><p>When we now execute <code>bundle install</code>, our dependencies will be installed and a new file <code>Gemfile.lock</code> pops up, which tracks the versions of those gems at time of install.</p><h2 id="simplest-sequel">Simplest Sequel</h2><p>To keep it simple, we’ll start with an in-memory <code>Sqlite</code> database for our application. This way we won’t have real persistence beyond a server restart, but we can setup <code>Sequel</code> and replace the connection with our postgres-db later. So first, let’s add <code>sequel</code> and <code>sqlite3</code> to our <code>Gemfile</code>.</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># frozen_string_literal: true</span>

<span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">git_source</span><span class="p">(</span><span class="ss">:github</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">repo_name</span><span class="o">|</span> <span class="s2">&quot;https://github.com/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>

<span class="n">gem</span> <span class="s1">&#39;grape&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;rack&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sequel&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span></code></pre></figure><p><strong>Note</strong> You might have to [install sqlite3 first][install_sqlite3].</p><p>Now that the dependencies are sorted, we can should have a look at our application again:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># application.rb</span>

<span class="k">class</span> <span class="nc">MyApp</span>
  <span class="k">def</span> <span class="nf">books</span>
    <span class="vi">@books</span> <span class="o">||=</span> <span class="o">[]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Application</span> <span class="o">=</span> <span class="no">MyApp</span><span class="o">.</span><span class="n">new</span></code></pre></figure><p>Our simple <code>@books</code> array may have been enough so far, but we want to take advantage of our new database-based-powers. To do that, we’ll first have to have a database. So let’s get real fancy and add a new <code>lib/initializers/</code> folder with our <code>database.rb</code> in it:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># lib/initializers/database.rb</span>

<span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="o">.</span><span class="n">sqlite</span>

<span class="no">DB</span><span class="o">.</span><span class="n">create_table?</span><span class="p">(</span><span class="ss">:books</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">primary_key</span> <span class="ss">:id</span>
  <span class="nb">String</span> <span class="ss">:title</span>
  <span class="nb">String</span> <span class="ss">:author</span>
<span class="k">end</span></code></pre></figure><p>If you’re coming from rails, you’ve just added your first <code>db/schema.rb</code>! Congratulations! The code above is rather simple:</p><ol><li><code>DB = Sequel.sqlite</code> creates a new in-memory <code>Sqlite3</code> database and (following sequels best practices) assigns it to the <code>DB</code> constant.</li><li><code>DB.create_table?(:books)</code> creates a table called <code>books</code>. The <code>?</code> indicates that the table will only be created if there is not already a table named <code>books</code>. This is not really necessary as long as the database does not live longer than the server, but in future this will avoid some errors.</li><li><code>primary_key :id</code>, adds a auto-incrementing <code>primary_key</code> called <code>id</code> to our table.</li><li><code>String :title</code> and <code>String :author</code> add two fields to our table called <code>title</code> and <code>author</code> which are both just strings. Interestingly, sequel breaks a common convention in ruby by defining methods with capitalized names. This makes it seem like you are just mentioning a constant, but you are actually calling a method on whatever sequel passes the <code>create_table?</code> block to. You can observe a similar behaviour with rubys own <code>Hash()</code> and <code>Array()</code> methods.</li></ol><p>Now you have a neat little <code>DB</code> all for yourself to fill up with <code>book</code>-records.</p><h2 id="getting-an-interface-to-the-database">Getting an interface to the database</h2><p>Although we now could just access <code>DB</code> from anywhere in our application, we should apply some encapsulation by adding a class that handles our database access. This will keep things nicely separated in case we ever need to change <code>DB</code>. Lets call these interfaces (we might need more in the future) <code>interfaces</code> and put them in our <code>/lib</code> folder.</p><pre><code class="language-bash">mkdir lib/repositories
touch lib/repositories/book_repository.rb
</code></pre><p>Now we can add our interface into this file.</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># lib/repositories/book_repository.rb</span>

<span class="k">class</span> <span class="nc">BookRepository</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">extend</span> <span class="no">Forwardable</span>

    <span class="n">def_delegator</span> <span class="ss">:data_set</span><span class="p">,</span> <span class="ss">:to_a</span>

    <span class="k">def</span> <span class="nf">data_set</span>
      <span class="vi">@data_set</span> <span class="o">||=</span> <span class="no">DB</span><span class="o">[</span><span class="ss">:books</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">set</span><span class="p">)</span>
      <span class="n">data_set</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">set</span><span class="p">)</span>
      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">)</span>
      <span class="nb">to_a</span><span class="o">.</span><span class="n">to_json</span>
    <span class="k">end</span>

    <span class="k">alias</span> <span class="o">&lt;&lt;</span> <span class="n">insert</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><p>Since the repository doesn’t really need state right now, we’ll just add the functionalities as class methods. A few things need to be explained here:</p><ol><li>We added <code>Forwardable</code> because we expect to delegate a lot of messages to</li><li>Our <code>data_set</code>. You can think of the <code>data_set</code> as our <code>books</code>-table in the database. You can access all your table using <code>DB[:"#{table_name}"]</code> but since we only have one, that’ll do for now.</li><li>We return our <code>BookRepository</code> to be compatible with our earlier implementation where we returned the <code>@books</code> variable after adding a new book. We also alias <code>&lt;&lt;</code> and <code>insert</code> for the same reason.</li><li>Since Grape will call <code>to_json</code> on everything we return in a block, we want the <code>to_json</code> method to return something useful. Like all books.</li></ol><p><strong>Note</strong>: For some reason, I had to add a <code>(*_)</code> to the <code>to_json</code> definition to silently swallow all arguments given to it. It seams that grape passes some argument to <code>to_json</code> when rendering <code>{books: books}</code> in the api.</p><h2 id="connecting-all-the-bits">Connecting all the bits</h2><p>Now we have a database and an interface to use it. But it’s not being loaded anywhere (life without rails autoload is hard I know). So let’s change that in our <code>app.rb</code>.</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># app.rb</span>

<span class="nb">require</span> <span class="s1">&#39;forwardable&#39;</span>

<span class="nb">require</span> <span class="s1">&#39;sqlite3&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sequel&#39;</span>

<span class="n">require_relative</span> <span class="s1">&#39;lib/initializers/db&#39;</span>
<span class="n">require_relative</span> <span class="s1">&#39;lib/repositories/book_repository&#39;</span>

<span class="k">class</span> <span class="nc">MyApp</span>
  <span class="k">def</span> <span class="nf">books</span>
    <span class="vi">@books</span> <span class="o">||=</span> <span class="no">BookRepository</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Application</span> <span class="o">=</span> <span class="no">MyApp</span><span class="o">.</span><span class="n">new</span></code></pre></figure><p>I decided to <code>require</code> all relevant dependencies for the application in <code>app.rb</code> while all the stuff for grape is being required in <code>api.rb</code>.</p><p>Alright! We switched out our primitive <code>Array</code> with our highly advanced and super sophisticated <code>BookRepository</code>. It sounds much more professional.</p><h2 id="adding-postgres">Adding Postgres</h2><p>The app works, has a real <code>SQL</code> database, and feels super fancy. But a big thing we want to learn in this part, is dealing with all the busywork of using a database, without the help of rails. Instead of using our in-memory sqlite3-database (or switching to a persisting sqlite3 database because thats cheating), we’ll add the great and mighty <code>postgres</code> to our stack. And to make things easier on our fingertips, we’ll add <code>dotenv</code> as well. But more of that later.</p><p><strong>Note</strong>: If you have not <a href="https://www.postgresql.org/docs/9.2/static/tutorial-install.html">installed postgres</a>, now would be a good time to do so. You’ll also need a user who can at least create a new database. So <a href="https://www.postgresql.org/docs/9.1/static/app-createuser.html">do that as well</a>.</p><p>Just switch out <code>sqlite3</code> with the nicely terse <code>pg</code> and add <code>dotenv</code> to your <code>Gemfile</code>.</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># Gemfile</span>

<span class="c1"># frozen_string_literal: true</span>

<span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">git_source</span><span class="p">(</span><span class="ss">:github</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">repo_name</span><span class="o">|</span> <span class="s2">&quot;https://github.com/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>

<span class="n">gem</span> <span class="s1">&#39;dotenv&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;grape&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;pg&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;rack&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sequel&#39;</span></code></pre></figure><h2 id="managing-the-database">Managing the database</h2><p>Now we could just create a database using postgres ourselves, or we anticipate that we are going to have to create and drop this database a lot, and just write ourselves some <code>rake</code> tasks to handle that. Again if you, like me, have mostly developed rails applications, you’ve probably run into the fine young tasks over at <code>rake db:</code> which are always nice enough to <code>create drop</code> and <code>seed</code> your database for you.</p><p>Even though we are intentionally avoiding rails paradigms in this series, we don’t have to live like savages. Therefore we will build our own <code>rake db:create db:drop db:setup</code>. So add <code>rake</code> to your <code>Gemfile</code> and ‘touch your <code>Rakefile</code>’. Only your <code>Rakefile</code>. It’s not that exciting.</p><pre><code class="language-bash">touch Rakefile
</code></pre><p>Now you can run <code>bundle exec rake</code> and it does nothing! Yey!</p><h3 id="the-basic-tasks">The basic tasks</h3><p>When you installed <code>postgres</code>, you probably installed the utilities that come with it. The one that we’re interested in is <code>createdb</code> (you can check if you have it using <code>which createdb</code>). Since we’re lazy, we’ll just use <code>createdb</code> to do all the work for us!</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">&#39;Creates a new database based on the variables in .env&#39;</span>
  <span class="n">task</span> <span class="ss">:create</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">&#39;Creating database...&#39;</span>
    <span class="c1"># Here we make sure to give feedback if the creation was successful</span>
    <span class="nb">puts</span> <span class="sb">`createdb &amp;&amp; echo &#39;Created db&#39;`</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><p><strong>Note</strong>: Those are back ticks around the <code>createdb</code> command. While we’re at it, we can add a <code>rake db:drop</code> as well:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">&#39;Creates a new database based on the variables in .env&#39;</span>
  <span class="n">task</span> <span class="ss">:create</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">&#39;Creating database...&#39;</span>
    <span class="c1"># Here we make sure to give feedback if the creation was successful</span>
    <span class="nb">puts</span> <span class="sb">`createdb &amp;&amp; echo &#39;Created db&#39;`</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s1">&#39;Drops the database specified in the variables in .env&#39;</span>
  <span class="n">task</span> <span class="ss">:drop</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">&#39;Dropping database...&#39;</span>
    <span class="c1"># Here we make sure to give feedback if the dropping was successful</span>
    <span class="nb">puts</span> <span class="sb">`dropdb &amp;&amp; echo &#39;Dropped db&#39;`</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><p>Now this won’t work because <code>createdb</code> and <code>dropdb</code> need arguments to work. But how do we get those arguments into our rake-task? If you guessed through rakes argument system, you guessed wrong. Because that’s tedious and hard on our fingertips. Instead we’ll use environment variables!</p><h3 id="using-dotenv">Using dotenv</h3><p><code>createdb</code> and <code>dropdb</code> are great for scripting since both use <a href="https://www.postgresql.org/docs/9.1/static/app-createdb.html">environment variables</a> (if you name them correctly). So you could just run your task like so:</p><pre><code class="language-bash">PGDATABASE=mydb PGPASS=12345 PGUSER=dau ... rake db:create
</code></pre><p>And everything would be fine. But again, we are lazy: We will not type in environment variables like some no good street urchin on every rake task good sir!</p><p>Instead we’ll write it into a file where we can read them from again and again. If you’ve not heard of <code>dotenv</code>, heres what it does: It loads all variables you define in a <code>.env</code> file into the environment. Simple as that. It’s a good idea not to start with the <code>.env</code> itself, but rather add a <code>.env.sample</code> file first that looks like this:</p><pre><code class="language-bash"># .env.sample

PGUSER=
PGPASS=
PGDATABASE=
PGHOST=
PGPORT=
</code></pre><p>Just leave the values blank. This file will be added to version control since there is nothing in it we want to hide.</p><p><strong>Note</strong>: If you are using <code>git</code> on your project, be sure to add <code>.env</code> to you <code>.gitignore</code> so you don’t accidentally add sensitive data to version control.</p><p>Now you can</p><pre><code class="language-bash">cp .env.sample .env
</code></pre><p>and fill in the blanks! If you want postgres to use a default value, just don’t write anything (so PGHOST and PGPORT stay default for example). The things you should fill out (for a smooth development experience) are PGUSER, PGPASS and PGDATABASE. If you have all of these filled out (with correct info of course), your rake tasks won’t bug you with password or user prompts.</p><p>“But wait!” you shout, excitedly. “Rake won’t load these variables on its own! How can it know about them!” And you’re right. Our <code>Rakefile</code> is still missing something.</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">desc</span> <span class="s1">&#39;Loads our .env into ENV&#39;</span>
<span class="n">task</span> <span class="ss">:environment</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s1">&#39;Loading environment...&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;dotenv/load&#39;</span>
<span class="k">end</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">&#39;Creates a new database based on the variables in .env&#39;</span>
  <span class="n">task</span> <span class="ss">:create</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">&#39;Creating database...&#39;</span>
    <span class="c1"># Here we make sure to give feedback if the creation was successful</span>
    <span class="nb">puts</span> <span class="sb">`createdb &amp;&amp; echo &#39;Created db&#39;`</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s1">&#39;Drops the database specified in the variables in .env&#39;</span>
  <span class="n">task</span> <span class="ss">:drop</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">&#39;Dropping database...&#39;</span>
    <span class="c1"># Here we make sure to give feedback if the dropping was successful</span>
    <span class="nb">puts</span> <span class="sb">`dropdb &amp;&amp; echo &#39;Dropped db&#39;`</span>
  <span class="k">end</span>

  <span class="c1"># Here we just invoke both tasks, one after the other</span>
  <span class="n">desc</span> <span class="s1">&#39;Resets our database by dropping and creating it again.&#39;</span>
  <span class="n">task</span> <span class="ss">:reset</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:drop&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:create&#39;</span><span class="o">].</span><span class="n">invoke</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><p>Now the <code>:environment</code> task requires <code>dotenv/load</code>, which loads the environment variables. The <code>:create =&gt; :environment</code> line says that <code>:environment</code> has to be invoked before <code>:create</code> can be invoked. This way we make sure the variables are loaded and <code>postgres</code> can access them.</p><p>The <code>:reset</code> task is supposed to ape <code>rake db:reset</code> we know and love from rails. It just drops the database and creates it again.</p><h3 id="switching-to-pg">Switching to pg</h3><p>Now we can just</p><pre><code class="language-bash">rake db:create
</code></pre><p>and we have our database. But the application is still trying to use a sqlite database. So we’ll quickly change the connection details in <code>lib/initializers/database.rb</code>:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;postgres://</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PGHOST&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PGDATABASE&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">?user=</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PGUSER&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PGPASS&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="no">DB</span><span class="o">.</span><span class="n">create_table?</span><span class="p">(</span><span class="ss">:books</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">primary_key</span> <span class="ss">:id</span>
  <span class="nb">String</span> <span class="ss">:title</span>
  <span class="nb">String</span> <span class="ss">:author</span>
<span class="k">end</span></code></pre></figure><p>It’s ugly I admit, but it works and shows you exactly what is going on.</p><h2 id="conclusion">Conclusion</h2><p>There you have it. You have your own little db-setup. And you did it all by yourself! No rails involved. You can try the whole thing out by starting your server using <code>rackup</code>, posting some books to it using <code>curl</code> (you can check <a href="/blog/off-the-rails/">part 1</a> again to see how exactly that works), restarting the server and visiting <code>http://localhost:9292/books</code> to see that your books were persisted.</p><p>And we didn’t have to change anything about our <code>api.rb</code>. Thats the power of encapsulation, kids!</p><h2 id="next-time">Next time</h2><p>A few things are still missing from our API:</p><ol><li>Business Logic</li><li>Authentication</li><li>Authorization</li><li>Probably something someone will mention in the comments</li></ol><p>So I don’t know what we’ll tackle next, but stay tuned!</p><hr style="border-top: 1px solid #9D9D9D ; color: #9D9D9D ;" class="endpost" /><div class="row sharebutton"><ul class="wrapper"><li class="title">Share</li></ul></div><div class="day-quote"><div class="title"></div><div class="content"></div></div><div class="row author"><div class="col-sm-2 image"> <img class="img-responsive center-block" src="https://haniyya.github.io/assets/images/author/logo_export.svg" alt=""></div><div class="col-sm-10 bio"><p class="title">Author</p><p class="name">Paul</p><p class="content">Independent Webdeveloper based in Kiel, Germany. Come read my stuff!</p></div></div><div class="disqus" id="comments"><div class="title"><h3><i class="fa fa-comments" aria-hidden="true"></i>&nbsp;Leave a comment on this post</h3></div><div class="content"><div id="disqus_thread"></div><script> var disqus_shortname = "brewing-bits-com"; var disqus_config = function () { if(typeof(this.page) == "undefined"){ this.page = {}; }; this.page.url = "https://brewing-bits.com/blog/off-the-rails-2/"; this.page.identifier = "/blog/off-the-rails-2/"; this.page.title = "Off the Rails! Part 2."; }; (function() { var d = document, s = d.createElement("script"); s.src = "https://brewing-bits-com.disqus.com/embed.js"; s.setAttribute("data-timestamp", +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></article></div></div></div><div class="footer"><div class="container-fluid"><div class="row-fluid"><div class="col-sm-4 copyright"> <span>Brewing Bits © 2016-2020 • All right reserved.</span></div><div class="col-sm-4 message"> <span>Brewing delicious lines of code.</span></div><div class="col-sm-4 madeby"> <span>Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div><a class="pull-right top" href="#top"><i class="fa fa-caret-up" aria-hidden="true"></i></a></div></div></div></div><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> <script src="https://haniyya.github.io/assets/javascripts/jekyll-spotify-plugin.min.js"></script> <script type="text/javascript" src="https://haniyya.github.io/assets/javascripts/post.js"></script> <script type="text/javascript"> jQuery(document).ready(function($) { $('.post > .row.content a').addClass('ga-event'); $('.page.spage > .row.content th a').addClass('ga-event'); $('.row.content li a').removeClass('ga-event'); $('a.ga-event').attr('onclick', 'ga(\'send\',\'event\',\'linkTo\',this.href,\'https://haniyya.github.io/blog/off-the-rails-2/\');'); }); </script> <script src="https://haniyya.github.io/assets/javascripts/global.js"></script></body></html>
